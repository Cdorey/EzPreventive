@page "/medicalhistory"
@using EzNutrition.Client.Services;
@using EzNutrition.Shared.Data.Entities;
@using EzNutrition.Shared.Utilities;
@inject HttpClient Http
@inject UserSessionService UserSession
@inject NavigationManager Navigation

<h3>病史记录</h3>
<div class="container">
    <div class="row mb-2">
        <Select TItem="Disease" TItemValue="int" DataSource="@diseasesInDB" LabelName="@nameof(Disease.FriendlyName)" ValueName="@nameof(Disease.DiseaseId)" Placeholder="请选择既往史" DefaultActiveFirstOption="false" EnableSearch OnSelectedItemChanged="OnSelectedItemChangedHandler" />
     </div>



     @foreach (var record in Diseases)
    {
        <div class="row mb-2">
            <div class="col-md-4 mb-2">
                <input class="form-control" value="@record.ICD10" readonly placeholder="ICD10(尚未实现)" />
            </div>
            <div class="col-md-4 mb-2">
                <input class="form-control" value="@record.FriendlyName" readonly placeholder="Diagnosis Name" />
            </div>
            <div class="col-md-4 mb-2">
                <button class="btn btn-danger" @onclick="async () =>await RemoveRecord(record)">删除记录</button>
            </div>
        </div>
    }
</div>

@code {
    private List<Disease>? diseasesInDB;

    public List<Disease> Diseases { get; set; } = new List<Disease>();

    [Parameter]
    public List<Advice> Advices { get; set; } = new List<Advice>();

    [Parameter]
    public EventCallback<List<Advice>> AdviceDataChanged { get; set; }

    private bool IsRemoveDisabled => Diseases.Count == 0;

    private async Task OnSelectedItemChangedHandler(Disease value)
    {
        if (diseasesInDB != null)
        {
            if (value.DiseaseId != 0 && !Diseases.Contains(value))
            {
                Diseases.Add(value);
            }
            Advices = await GetAdvicesAsync();
            await AdviceDataChanged.InvokeAsync(Advices);
        }
    }

    private async Task<List<Advice>> GetAdvicesAsync()
    {
        if (UserSession.UserInfo == null)
        {
            Navigation.NavigateTo("/");
            return new List<Advice>();
        }

        var list = from disease in Diseases select disease.DiseaseId;
        if (list.Any())
        {
            var result = await Http.PostAuthorizedJsonAsync(UserSession.UserInfo.Token, "Prescription/advices", list.ToList());
            return await result.Content.ReadFromJsonAsync<List<Advice>>() ?? Advices;
        }
        else
        {
            return new List<Advice>();
        }
    }


    private async Task RemoveRecord(Disease record)
    {
        Diseases.Remove(record);
        Advices = await GetAdvicesAsync();
        await AdviceDataChanged.InvokeAsync(Advices);
    }

    protected override async Task OnInitializedAsync()
    {
        if (UserSession.UserInfo == null)
        {
            Navigation.NavigateTo("/");
            return;
        }
        diseasesInDB = await Http.GetAuthorizedJsonAsync<List<Disease>>(UserSession.UserInfo.Token, $"Prescription/diseases");
        await base.OnInitializedAsync();
    }
}
